---
- name: Verify pi-log installation
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Check service file exists
      ansible.builtin.stat:
        path: /etc/systemd/system/pi-log.service
      register: svc_file

    - name: Assert service file exists
      ansible.builtin.assert:
        that:
          - svc_file.stat.exists

    - name: Check service is enabled
      ansible.builtin.systemd:
        name: pi-log
        enabled: true
      register: svc_enabled
      changed_when: false

    - name: Assert service is enabled
      ansible.builtin.assert:
        that:
          - svc_enabled.status.Enabled

    - name: Check service is running
      ansible.builtin.systemd:
        name: pi-log
        state: started
      register: svc_running
      changed_when: false

    - name: Assert service is running
      ansible.builtin.assert:
        that:
          - svc_running.status.ActiveState == "active"

- name: Run role again to test idempotence
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Re-run the role
      ansible.builtin.include_role:
        name: pi_log
      register: rerun

    - name: Assert idempotence
      ansible.builtin.assert:
        that:
          - rerun is not changed
        fail_msg: "Role is not idempotent"
        success_msg: "Role is idempotent"
